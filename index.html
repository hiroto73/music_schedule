<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ライブ練習日程調整アプリ</title>
    
    <style>
        /* ===== 基本スタイル ===== */
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #6c757d;
            --text-color: #333;
            --vertical-header-bg: #f2f2f2;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            background-color: var(--light-gray);
            color: var(--text-color);
            overscroll-behavior-y: contain; /* iOSのバウンススクロールを抑制 */
        }

        .screen {
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            text-align: center;
        }

        button {
            cursor: pointer;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1em;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        input[type="text"], input[type="email"], input[type="password"], input[type="date"], textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        /* ===== ユーティリティ ===== */
        .password-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        .password-container input {
            flex-grow: 1;
        }
        .password-toggle-btn {
            margin-left: -1px;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            font-size: 0.9em;
            padding: 11.5px 8px; /* inputの高さに合わせる */
            background-color: var(--dark-gray);
        }
        .password-toggle-btn:hover {
            background-color: #5a6268;
        }

        /* ===== ローダー ===== */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== ログイン・登録画面 ===== */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .form-container {
            background: white;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        #login-screen h1 { margin-top: 0;}
        #login-screen h2 { text-align: left; margin-bottom: 1em; color: #333;}
        .toggle-form-link {
            text-align: center;
            margin-top: 1em;
            font-size: 0.9em;
        }
        .toggle-form-link a {
            color: var(--primary-color);
            text-decoration: none;
        }

        /* ===== ヘッダー ===== */
        header {
            display: flex;
            align-items: center;
            justify-content: center; /* 中央寄せ */
            background-color: white;
            padding: 10px 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative; /* 子要素の配置基準 */
        }
        header h1 {
            margin: 0;
            font-size: 1.2em;
            color: var(--text-color);
        }
        #hamburger-btn, #back-to-main-btn {
            position: absolute;
            left: 15px;
            font-size: 1.5em;
            background: none;
            border: none;
            color: var(--text-color);
            padding: 0 10px;
        }

        /* ===== メイン画面 ===== */
        #main-screen main {
            padding: 15px;
        }
        #song-list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .song-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .song-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .song-item-info h3 {
            margin: 0 0 5px 0;
            text-align: left;
            color: var(--text-color);
        }
        .song-item-info p {
            margin: 0;
            font-size: 0.9em;
            color: var(--dark-gray);
        }
        .song-item-delete-btn {
            background: none;
            border: none;
            color: var(--dark-gray);
            font-size: 1.5em;
            padding: 5px;
        }
        .no-songs-message {
            text-align: center;
            color: var(--dark-gray);
            margin-top: 50px;
        }
        .fab {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            font-size: 2em;
            line-height: 56px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 0;
        }

        /* ===== サイドパネル ===== */
        #side-panel {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: left 0.3s ease-in-out;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #side-panel.open {
            left: 0;
        }
        #panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        #panel-overlay.active {
            display: block;
        }
        .panel-content { flex-grow: 1; }
        #side-panel h2 { text-align: left; margin-top: 0;}
        .info-item { margin-bottom: 15px; }
        .info-item label { font-weight: bold; display: block; margin-bottom: 5px;}
        .info-item p { margin: 0; background: var(--light-gray); padding: 8px; border-radius: 4px; }
        #info-nickname { margin: 0; }
        #save-nickname-btn { margin-left: 10px; font-size: 0.9em; }
        #logout-btn {
            background-color: var(--danger-color);
            margin-top: auto; /* 一番下に配置 */
            width: 100%;
        }
        #close-panel-btn {
            background: var(--dark-gray);
            width: 100%;
            margin-top: 10px;
        }

        /* ===== 空きコマ入力画面 ===== */
        #schedule-input-screen main { padding: 15px; }
        .user-info-bar {
            background: var(--medium-gray);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        .user-info-bar span { margin: 0 10px; }
        #schedule-grid-container {
            overflow-x: auto; /* 横スクロールを可能に */
            padding-bottom: 10px;
        }
        #schedule-grid {
            display: grid;
            border-collapse: collapse;
            min-width: 600px; /* スマホでも最低限の幅を確保 */
        }
        .grid-header {
            background-color: var(--vertical-header-bg);
            padding: 8px 5px;
            font-weight: bold;
            text-align: center;
            border: 1px solid #ddd;
            position: sticky; /* スクロールしても追従 */
            top: 0;
            z-index: 10;
        }
        .grid-period-header {
            writing-mode: vertical-rl; /* 文字を縦書きに */
            text-orientation: mixed;
            transform: rotate(180deg);
            padding: 5px 8px;
            white-space: nowrap;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        .grid-cell {
            border: 1px solid #ddd;
            min-height: 80px;
            cursor: pointer;
            position: relative;
            background-color: white;
            transition: background-color 0.2s;
        }
        .grid-cell.selected {
            background-color: #aaeebb;
        }
        .grid-cell.disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }
        .grid-cell.confirm-selected {
            outline: 3px solid var(--primary-color);
            outline-offset: -3px;
        }
        .cell-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 5px;
        }
        .participant-count {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
        }
        .cell-menu-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: none;
            border: none;
            color: var(--dark-gray);
            font-size: 1.2em;
            line-height: 1;
            padding: 2px 4px;
        }
        .action-buttons {
            text-align: center;
            margin-top: 20px;
        }
        #confirmation-controls {
            text-align: center;
            padding: 15px;
            background-color: #fffbe6;
            border: 1px solid #ffe58f;
            border-radius: 5px;
            margin: 20px 0;
        }

        /* ===== 確定済み練習一覧 ===== */
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 30px 0;
        }
        #confirmed-practices-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .confirmed-day-group h3 {
            text-align: left;
            color: var(--text-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .confirmed-practice-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .confirmed-practice-item p {
            margin: 5px 0;
        }
        .confirmed-practice-item.warning {
            border: 2px solid var(--danger-color);
            background-color: #fbecec;
        }
        .warning-message {
            color: var(--danger-color);
            font-weight: bold;
            font-size: 0.9em;
            margin-top: 10px;
        }

        /* ===== モーダル共通 ===== */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-modal-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.8em;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        #generated-link-container { margin-top: 20px; }
        #generated-link {
            width: 100%;
            height: 80px;
            resize: none;
            background: var(--light-gray);
        }
        #copy-link-btn { margin-top: 10px; }
        #participants-list {
            list-style-type: none;
            padding: 0;
        }
        #participants-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        /* ===== 練習コマ確定モーダル ===== */
        #confirm-slot-list li {
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .form-item { margin: 15px 0; }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .checkbox-group input {
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <div id="loader" class="loader-container" style="display: none;">
        <div class="loader"></div>
    </div>

    <div id="login-screen" class="screen">
        <div class="form-container">
            <h1>ライブ練習日程調整</h1>
            <div id="register-form">
                <h2>ユーザー登録</h2>
                <input type="email" id="register-email" placeholder="メールアドレス" required>
                <div class="password-container">
                    <input type="password" id="register-password" placeholder="パスワード" required>
                    <button type="button" class="password-toggle-btn">表示</button>
                </div>
                <input type="text" id="register-nickname" placeholder="ニックネーム" required>
                <input type="text" id="register-circle-code" placeholder="サークルコード" required>
                <button id="register-btn">登録</button>
                <p class="toggle-form-link">すでに登録済みの方は<a href="#" id="show-login-link">こちら</a></p>
            </div>
            <div id="login-form" style="display: none;">
                <h2>ログイン</h2>
                <input type="email" id="login-email" placeholder="メールアドレス" required>
                 <div class="password-container">
                    <input type="password" id="login-password" placeholder="パスワード" required>
                    <button type="button" class="password-toggle-btn">表示</button>
                </div>
                <button id="login-btn">ログイン</button>
                <p class="toggle-form-link">新規登録の方は<a href="#" id="show-register-link">こちら</a></p>
            </div>
        </div>
    </div>

    <div id="main-screen" class="screen" style="display: none;">
        <header>
            <button id="hamburger-btn">≡</button>
            <h1>練習日程一覧</h1>
        </header>
        <main id="song-list-container">
            <p class="no-songs-message">参加中の曲はありません。<br>右下の「+」ボタンから新しい練習日程を作成するか、共有されたリンクを開いてください。</p>
        </main>
        <button id="add-song-btn" class="fab">+</button>
    </div>

    <div id="side-panel">
        <div class="panel-content">
            <h2>登録情報</h2>
            <div class="info-item">
                <label>メールアドレス:</label>
                <p id="info-email"></p>
            </div>
            <div class="info-item">
                <label>パスワード:</label>
                <div class="password-container">
                    <p id="info-password"></p>
                    <button type="button" id="info-password-toggle" class="password-toggle-btn">表示</button>
                </div>
            </div>
            <div class="info-item">
                <label>ニックネーム:</label>
                <input type="text" id="info-nickname">
                <button id="save-nickname-btn">保存</button>
            </div>
             <div class="info-item">
                <label>サークルコード:</label>
                <p id="info-circle-code"></p>
            </div>
            <button id="logout-btn">ログアウト</button>
            <button id="close-panel-btn">閉じる</button>
        </div>
    </div>
    <div id="panel-overlay"></div>


    <div id="create-link-modal" class="modal-container" style="display: none;">
        <div class="modal-content">
            <span class="close-modal-btn">&times;</span>
            <h2>日程調整リンク作成</h2>
            <input type="text" id="create-song-title" placeholder="曲名" required>
            <label for="create-start-date">練習可能な期間</label>
            <input type="date" id="create-start-date" required>
            <span>〜</span>
            <input type="date" id="create-end-date" required>
            <button id="generate-link-btn">作成</button>
            <div id="generated-link-container" style="display: none;">
                <p>以下のリンクを共有してください:</p>
                <textarea id="generated-link" readonly></textarea>
                <button id="copy-link-btn">コピー</button>
            </div>
        </div>
    </div>

    <div id="schedule-input-screen" class="screen" style="display: none;">
        <header>
             <button id="back-to-main-btn">&lt; 戻る</button>
            <h1 id="schedule-song-title"></h1>
        </header>
        <main>
            <div class="user-info-bar">
                <span>サークル: <b id="schedule-circle-code"></b></span>
                <span>名前: <b id="schedule-nickname"></b></span>
            </div>
            <div id="schedule-grid-container">
                </div>
            <div class="action-buttons">
                <button id="save-schedule-btn">保存</button>
                <button id="edit-schedule-btn" style="display:none;">編集する</button>
            </div>
             <hr>
            <h2>練習コマ確定（代表者のみ）</h2>
            <p id="confirmation-unavailable-msg" style="display:none;">あなたが作成した日程ではないため、コマの確定はできません。</p>
            <div id="confirmation-controls" style="display:none;">
                 <p>下の表から確定したいコマを選択してください。</p>
                <button id="show-confirmation-screen-btn">選択したコマを確定する</button>
            </div>
            <h2>確定済み練習一覧</h2>
            <div id="confirmed-practices-container">
                </div>
        </main>
    </div>
    
    <div id="participants-modal" class="modal-container" style="display: none;">
        <div class="modal-content">
             <span class="close-modal-btn">&times;</span>
            <h3 id="participants-modal-title">参加予定者</h3>
            <ul id="participants-list"></ul>
        </div>
    </div>

    <div id="practice-confirmation-modal" class="modal-container" style="display:none;">
        <div class="modal-content">
            <span class="close-modal-btn">&times;</span>
            <h2>練習コマ確定</h2>
            <p>以下のコマを確定します：</p>
            <ul id="confirm-slot-list"></ul>
            <div class="form-item">
                <label for="confirm-room">練習部屋 (必須)</label>
                <input type="text" id="confirm-room" placeholder="例: B135">
            </div>
            <div class="form-item">
                <label>使用機材 (複数選択可、在庫: 各3)</label>
                <div id="confirm-equipment" class="checkbox-group">
                    <label><input type="checkbox" value="ベーアン"> ベーアン</label>
                    <label><input type="checkbox" value="キーボード"> キーボード</label>
                    <label><input type="checkbox" value="スプラッシュ"> スプラッシュ</label>
                    <label><input type="checkbox" value="ハイハット"> ハイハット</label>
                </div>
            </div>
            <button id="finalize-confirmation-btn">この内容で確定する</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ===== DOM要素の取得 =====
            const screens = {
                login: document.getElementById('login-screen'),
                main: document.getElementById('main-screen'),
                scheduleInput: document.getElementById('schedule-input-screen'),
            };
            const passwordToggles = document.querySelectorAll('.password-toggle-btn');
            // ... 他の多くの要素も同様に取得 ...

            // ===== アプリケーションの状態管理 =====
            let state = {
                currentUser: null, // { email, password, nickname, circleCode }
                allData: {},       // LocalStorageから読み込んだ全データ
                currentSongId: null, // 表示中の曲のID
                confirmingSlots: [], // 確定中のスロット
            };

            // ===== 定数 =====
            const PERIODS = ['1限', '昼', '2限', '3限', '4限', '5限', '6限', '7限'];
            const EQUIPMENT_STOCK = { 'ベーアン': 3, 'キーボード': 3, 'スプラッシュ': 3, 'ハイハット': 3 };

            // ===== データ管理（LocalStorage）=====
            const dataManager = {
                load: () => {
                    const data = localStorage.getItem('liveScheduleApp');
                    state.allData = data ? JSON.parse(data) : { users: {}, songs: {} };
                },
                save: () => {
                    localStorage.setItem('liveScheduleApp', JSON.stringify(state.allData));
                },
                getUser: (email) => state.allData.users[email],
                setUser: (user) => {
                    state.allData.users[user.email] = user;
                    dataManager.save();
                },
                getSong: (songId) => state.allData.songs[songId],
                setSong: (song) => {
                    state.allData.songs[song.id] = song;
                    dataManager.save();
                },
                deleteSong: (songId) => {
                    delete state.allData.songs[songId];
                    dataManager.save();
                }
            };


            // ===== 初期化処理 =====
            function init() {
                dataManager.load();
                
                // ログイン状態を確認
                const loggedInUserEmail = localStorage.getItem('loggedInUser');
                if (loggedInUserEmail) {
                    state.currentUser = dataManager.getUser(loggedInUserEmail);
                }

                handleRouting();
                setupEventListeners();
            }

            // ===== 画面遷移（ルーティング）=====
            function showScreen(screenName) {
                Object.values(screens).forEach(s => s.style.display = 'none');
                if (screens[screenName]) {
                    screens[screenName].style.display = 'block';
                }
            }

            function handleRouting() {
                const params = new URLSearchParams(window.location.search);
                const songIdFromUrl = params.get('id');

                if (!state.currentUser) {
                    showScreen('login');
                    return;
                }

                if (songIdFromUrl) {
                    // URLに曲IDがあれば、空きコマ入力画面へ
                    importSongFromUrl(params);
                    state.currentSongId = songIdFromUrl;
                    showScheduleInputScreen();
                } else {
                    // なければメイン画面へ
                    showMainScreen();
                }
            }
            
            // URLから曲情報をインポートする
            function importSongFromUrl(params) {
                const songId = params.get('id');
                if (!songId || dataManager.getSong(songId)) {
                    // 既に存在する場合は何もしない
                    return;
                }

                // 新規曲としてLocalStorageに保存
                const newSong = {
                    id: songId,
                    creatorNickname: params.get('creator'),
                    circleCode: params.get('circle'),
                    songTitle: decodeURIComponent(params.get('song')),
                    startDate: params.get('start'),
                    endDate: params.get('end'),
                    participants: [],
                    availability: {},
                    confirmed: [],
                };
                dataManager.setSong(newSong);
            }


            // ===== UI更新関数 =====

            /** メイン画面の表示 */
            function showMainScreen() {
                showScreen('main');
                const songListContainer = document.getElementById('song-list-container');
                songListContainer.innerHTML = '';
                
                const user = state.currentUser;
                const today = new Date().toISOString().split('T')[0];

                const filteredSongs = Object.values(state.allData.songs).filter(song =>
                    song.circleCode === user.circleCode &&
                    (song.creatorNickname === user.nickname || (song.participants && song.participants.includes(user.nickname))) &&
                    new Date(song.endDate) >= new Date(today.split('T')[0])
                );

                if (filteredSongs.length === 0) {
                    songListContainer.innerHTML = `<p class="no-songs-message">参加中の曲はありません。<br>右下の「+」ボタンから新しい練習日程を作成するか、共有されたリンクを開いてください。</p>`;
                    return;
                }

                filteredSongs.forEach(song => {
                    const item = document.createElement('div');
                    item.className = 'song-item';
                    item.dataset.songId = song.id;
                    
                    let creatorInfo = `作成者: ${song.creatorNickname}`;
                    if (song.creatorNickname === user.nickname) {
                        creatorInfo += ' (あなた)';
                    }
                    
                    item.innerHTML = `
                        <div class="song-item-info">
                            <h3>${song.songTitle}</h3>
                            <p>${creatorInfo} | 期間: ${song.startDate} ~ ${song.endDate}</p>
                        </div>
                        ${song.creatorNickname === user.nickname ? '<button class="song-item-delete-btn">⋮</button>' : ''}
                    `;
                    songListContainer.appendChild(item);
                });
            }

            /** 空きコマ入力画面の表示 */
            function showScheduleInputScreen() {
                showScreen('scheduleInput');
                const song = dataManager.getSong(state.currentSongId);
                if (!song) {
                    alert('曲が見つかりません。メイン画面に戻ります。');
                    window.location.search = ''; // URLパラメータを消してリロード
                    return;
                }

                // 曲情報を表示
                document.getElementById('schedule-song-title').textContent = song.songTitle;
                document.getElementById('schedule-circle-code').textContent = song.circleCode;
                document.getElementById('schedule-nickname').textContent = state.currentUser.nickname;
                
                // グリッドを生成
                generateScheduleGrid(song);

                // 確定済みコマを表示
                renderConfirmedPractices(song);

                // 確定機能の表示制御
                const isCreator = song.creatorNickname === state.currentUser.nickname;
                document.getElementById('confirmation-controls').style.display = isCreator ? 'block' : 'none';
                document.getElementById('confirmation-unavailable-msg').style.display = isCreator ? 'none' : 'block';

                // 参加者リストに追加
                if (!song.participants.includes(state.currentUser.nickname)) {
                    song.participants.push(state.currentUser.nickname);
                    dataManager.setSong(song);
                }
            }

            /** 日程グリッドの生成 */
            function generateScheduleGrid(song) {
                const container = document.getElementById('schedule-grid-container');
                container.innerHTML = '';
                const grid = document.createElement('div');
                grid.id = 'schedule-grid';

                const dates = getDatesInRange(song.startDate, song.endDate);
                grid.style.gridTemplateColumns = `auto repeat(${dates.length}, 1fr)`;
                
                // ヘッダー行（日付）
                grid.innerHTML += `<div class="grid-header grid-period-header"></div>`; // 左上の空セル
                dates.forEach(date => {
                    grid.innerHTML += `<div class="grid-header">${formatDate(date)}</div>`;
                });

                // データ行（時限ごと）
                const userAvailability = (song.availability && song.availability[state.currentUser.nickname]) || [];
                
                PERIODS.forEach(period => {
                    let rowHtml = `<div class="grid-header grid-period-header">${period}</div>`;
                    dates.forEach(date => {
                        const cellId = `${date.toISOString().split('T')[0]}_${period}`;
                        const totalParticipants = Object.values(song.availability || {})
                            .filter(avail => avail.includes(cellId)).length;
                        
                        const isSelected = userAvailability.includes(cellId);
                        const isConfirmed = isSlotConfirmed(song, cellId);

                        rowHtml += `
                            <div class="grid-cell ${isSelected ? 'selected' : ''} ${isConfirmed ? 'disabled' : ''}" data-cell-id="${cellId}">
                                <div class="cell-content">
                                    <span class="participant-count">${totalParticipants > 0 ? totalParticipants : ''}</span>
                                </div>
                                ${totalParticipants > 0 ? `<button class="cell-menu-btn" data-cell-id="${cellId}">･･･</button>`: ''}
                            </div>
                        `;
                    });
                    rowHtml += ``;
                    grid.innerHTML += rowHtml;
                });
                container.appendChild(grid);
            }
            
            /** 確定済みコマの表示 */
            function renderConfirmedPractices(song) {
                const container = document.getElementById('confirmed-practices-container');
                container.innerHTML = '';

                const confirmedPractices = song.confirmed || [];
                const groupedByDate = confirmedPractices.reduce((acc, practice) => {
                    (acc[practice.date] = acc[practice.date] || []).push(practice);
                    return acc;
                }, {});

                Object.keys(groupedByDate).sort().forEach(date => {
                    const dayGroupEl = document.createElement('div');
                    dayGroupEl.className = 'confirmed-day-group';
                    dayGroupEl.innerHTML = `<h3>${formatDate(new Date(date))}</h3>`;

                    groupedByDate[date].forEach(practice => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'confirmed-practice-item';
                        if (practice.warnings && practice.warnings.length > 0) {
                            itemEl.classList.add('warning');
                        }

                        itemEl.innerHTML = `
                            <p><strong>時間:</strong> ${practice.periods.join(', ')}</p>
                            <p><strong>部屋:</strong> ${practice.room}</p>
                            <p><strong>機材:</strong> ${practice.equipment.length > 0 ? practice.equipment.join(', ') : 'なし'}</p>
                            <p><strong>参加者:</strong> ${practice.participants.join(', ')}</p>
                            ${(practice.warnings && practice.warnings.length > 0) ? `<div class="warning-message">${practice.warnings.join('<br>')}</div>` : ''}
                        `;
                        dayGroupEl.appendChild(itemEl);
                    });
                    container.appendChild(dayGroupEl);
                });
            }


            // ===== イベントリスナー設定 =====
            function setupEventListeners() {
                // パスワード表示切替
                passwordToggles.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const passwordInput = e.target.previousElementSibling;
                        if (passwordInput.type === 'password') {
                            passwordInput.type = 'text';
                            e.target.textContent = '隠す';
                        } else {
                            passwordInput.type = 'password';
                            e.target.textContent = '表示';
                        }
                    });
                });

                // 登録・ログインフォーム切替
                document.getElementById('show-login-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('register-form').style.display = 'none';
                    document.getElementById('login-form').style.display = 'block';
                });
                document.getElementById('show-register-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('register-form').style.display = 'block';
                    document.getElementById('login-form').style.display = 'none';
                });

                // ユーザー登録
                document.getElementById('register-btn').addEventListener('click', handleRegister);
                // ログイン
                document.getElementById('login-btn').addEventListener('click', handleLogin);
                // ログアウト
                document.getElementById('logout-btn').addEventListener('click', handleLogout);

                // ハンバーガーメニュー
                const sidePanel = document.getElementById('side-panel');
                const panelOverlay = document.getElementById('panel-overlay');
                document.getElementById('hamburger-btn').addEventListener('click', () => {
                    populateUserInfoPanel();
                    sidePanel.classList.add('open');
                    panelOverlay.classList.add('active');
                });
                document.getElementById('close-panel-btn').addEventListener('click', closePanel);
                panelOverlay.addEventListener('click', closePanel);

                // ニックネーム保存
                document.getElementById('save-nickname-btn').addEventListener('click', saveNickname);

                // 曲リストのクリック
                document.getElementById('song-list-container').addEventListener('click', (e) => {
                    const songItem = e.target.closest('.song-item');
                    const deleteBtn = e.target.closest('.song-item-delete-btn');

                    if (deleteBtn) {
                        // 削除ボタンが押された場合
                        const songId = songItem.dataset.songId;
                        if (confirm('この練習日程を削除しますか？\n関連するすべてのデータが失われます。')) {
                            dataManager.deleteSong(songId);
                            showMainScreen();
                        }
                    } else if (songItem) {
                        // 曲アイテム自体がクリックされた場合
                        state.currentSongId = songItem.dataset.songId;
                        const song = dataManager.getSong(state.currentSongId);
                        // URLを更新して画面遷移
                        const params = new URLSearchParams({
                            id: song.id,
                            song: encodeURIComponent(song.songTitle),
                            circle: song.circleCode,
                            creator: song.creatorNickname,
                            start: song.startDate,
                            end: song.endDate
                        });
                        history.pushState({}, '', `?${params.toString()}`);
                        showScheduleInputScreen();
                    }
                });
                
                // 曲作成ボタン(+)
                document.getElementById('add-song-btn').addEventListener('click', () => {
                    document.getElementById('create-link-modal').style.display = 'flex';
                });

                // モーダル閉じるボタン
                document.querySelectorAll('.close-modal-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.target.closest('.modal-container').style.display = 'none';
                    });
                });

                // リンク作成
                document.getElementById('generate-link-btn').addEventListener('click', generateShareLink);
                // リンクコピー
                document.getElementById('copy-link-btn').addEventListener('click', copyLink);

                // メイン画面へ戻るボタン
                document.getElementById('back-to-main-btn').addEventListener('click', () => {
                    history.pushState({}, '', window.location.pathname);
                    showMainScreen();
                });
                
                // 空きコマグリッドのクリック
                document.getElementById('schedule-grid-container').addEventListener('click', (e) => {
                    const cell = e.target.closest('.grid-cell');
                    const menuBtn = e.target.closest('.cell-menu-btn');

                    if (menuBtn) {
                        // 参加者一覧表示
                        showParticipantsModal(menuBtn.dataset.cellId);
                    } else if (cell && !cell.classList.contains('disabled')) {
                        // 空きコマ選択/解除
                        cell.classList.toggle('selected');
                    }
                });
                
                // 空きコマ保存
                document.getElementById('save-schedule-btn').addEventListener('click', saveSchedule);
                
                // 参加者一覧モーダル
                function showParticipantsModal(cellId) {
                    const song = dataManager.getSong(state.currentSongId);
                    const participants = Object.entries(song.availability || {})
                        .filter(([_, avail]) => avail.includes(cellId))
                        .map(([nickname, _]) => nickname);

                    const [date, period] = cellId.split('_');
                    document.getElementById('participants-modal-title').textContent = `${formatDate(new Date(date))} ${period} の参加予定者`;
                    const listEl = document.getElementById('participants-list');
                    listEl.innerHTML = participants.length > 0 
                        ? participants.map(p => `<li>${p}</li>`).join('') 
                        : '<li>参加予定者はいません</li>';
                    
                    document.getElementById('participants-modal').style.display = 'flex';
                }

                // 練習コマ確定関連
                document.getElementById('show-confirmation-screen-btn').addEventListener('click', () => {
                    // 確定モードでは、通常の空きコマ選択（selectedクラスの付け外し）と区別したい
                    // ここではシンプルに、グリッドのクリックイベントで 'confirm-selected' を付け外しする前提
                    alert('確定したいコマをクリックで選択してください。選択後、再度「選択したコマを確定する」ボタンを押してください。');
                });
                document.getElementById('show-confirmation-screen-btn').addEventListener('click', showConfirmationScreen);
                document.getElementById('finalize-confirmation-btn').addEventListener('click', finalizeConfirmation);
            }
            
            // ===== イベントハンドラ関数 =====
            
            function handleRegister() {
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const nickname = document.getElementById('register-nickname').value.trim();
                const circleCode = document.getElementById('register-circle-code').value.trim();

                if (!email || !password || !nickname || !circleCode) {
                    alert('すべての項目を入力してください。');
                    return;
                }
                if (dataManager.getUser(email)) {
                    alert('このメールアドレスは既に使用されています。');
                    return;
                }

                const newUser = { email, password, nickname, circleCode };
                dataManager.setUser(newUser);
                loginUser(newUser);
            }

            function handleLogin() {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;
                const user = dataManager.getUser(email);

                if (user && user.password === password) {
                    loginUser(user);
                } else {
                    alert('メールアドレスまたはパスワードが間違っています。');
                }
            }
            
            function loginUser(user) {
                state.currentUser = user;
                localStorage.setItem('loggedInUser', user.email);
                handleRouting();
            }

            function handleLogout() {
                state.currentUser = null;
                localStorage.removeItem('loggedInUser');
                closePanel();
                window.location.href = window.location.pathname; // ページをリロードしてログイン画面へ
            }
            
            function populateUserInfoPanel() {
                const user = state.currentUser;
                document.getElementById('info-email').textContent = user.email;
                document.getElementById('info-password').textContent = '•'.repeat(user.password.length);
                document.getElementById('info-password').dataset.password = user.password;
                document.getElementById('info-nickname').value = user.nickname;
                document.getElementById('info-circle-code').textContent = user.circleCode;

                document.getElementById('info-password-toggle').addEventListener('click', e => {
                    const p = document.getElementById('info-password');
                    if (p.textContent.includes('•')) {
                        p.textContent = p.dataset.password;
                        e.target.textContent = '隠す';
                    } else {
                        p.textContent = '•'.repeat(p.dataset.password.length);
                        e.target.textContent = '表示';
                    }
                });
            }
            
            function saveNickname() {
                const newNickname = document.getElementById('info-nickname').value.trim();
                if (!newNickname) {
                    alert('ニックネームは空にできません。');
                    return;
                }
                
                // TODO: 他のデータ内のニックネームも更新する必要がある
                // このLocalStorageベースの実装では非常に複雑になるため、今回はユーザー情報のみ更新
                state.currentUser.nickname = newNickname;
                dataManager.setUser(state.currentUser);
                alert('ニックネームを保存しました。');
                closePanel();
                // メイン画面の再描画
                showMainScreen();
            }

            function closePanel() {
                document.getElementById('side-panel').classList.remove('open');
                document.getElementById('panel-overlay').classList.remove('active');
            }

            function generateShareLink() {
                const songTitle = document.getElementById('create-song-title').value.trim();
                const startDate = document.getElementById('create-start-date').value;
                const endDate = document.getElementById('create-end-date').value;
                
                if (!songTitle || !startDate || !endDate) {
                    alert('すべての項目を入力してください。');
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    alert('終了日は開始日より後に設定してください。');
                    return;
                }
                
                const user = state.currentUser;
                // ユニークなIDを生成
                const songId = `${user.circleCode}-${Date.now()}`;
                
                const song = {
                    id: songId,
                    creatorNickname: user.nickname,
                    circleCode: user.circleCode,
                    songTitle: songTitle,
                    startDate: startDate,
                    endDate: endDate,
                    participants: [user.nickname], // 作成者も参加者
                    availability: {},
                    confirmed: [],
                };
                dataManager.setSong(song);

                const params = new URLSearchParams({
                    id: song.id,
                    song: encodeURIComponent(song.songTitle),
                    circle: song.circleCode,
                    creator: song.creatorNickname,
                    start: song.startDate,
                    end: song.endDate
                });
                const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;

                document.getElementById('generated-link').value = url;
                document.getElementById('generated-link-container').style.display = 'block';
            }

            function copyLink() {
                const linkText = document.getElementById('generated-link');
                linkText.select();
                navigator.clipboard.writeText(linkText.value).then(() => {
                    alert('リンクをコピーしました！');
                });
            }
            
            function saveSchedule() {
                const song = dataManager.getSong(state.currentSongId);
                const selectedCells = Array.from(document.querySelectorAll('.grid-cell.selected:not(.disabled)'))
                                           .map(cell => cell.dataset.cellId);
                
                if (!song.availability) song.availability = {};
                song.availability[state.currentUser.nickname] = selectedCells;
                dataManager.setSong(song);
                
                alert('空きコマを保存しました。');
                
                // ★★★ 修正点 ★★★
                // 画面全体を再描画して、参加者人数の更新を確実に反映させる
                showScheduleInputScreen();
            }

            function showConfirmationScreen() {
                // .confirm-selectedクラスを一旦クリア
                document.querySelectorAll('.grid-cell.confirm-selected').forEach(c => c.classList.remove('confirm-selected'));

                // ユーザーが選択したコマを取得
                state.confirmingSlots = Array.from(document.querySelectorAll('.grid-cell.selected:not(.disabled)'))
                    .map(c => c.dataset.cellId);
                
                if (state.confirmingSlots.length === 0) {
                    alert('確定するコマを1つ以上選択してください。（緑色に選択されているコマが対象です）');
                    return;
                }

                // モーダルに選択したコマを表示
                const listEl = document.getElementById('confirm-slot-list');
                listEl.innerHTML = state.confirmingSlots.map(slotId => {
                    const [date, period] = slotId.split('_');
                    return `<li>${formatDate(new Date(date))} ${period}</li>`;
                }).join('');

                // フォームをリセット
                document.getElementById('confirm-room').value = '';
                document.querySelectorAll('#confirm-equipment input[type="checkbox"]').forEach(cb => cb.checked = false);

                document.getElementById('practice-confirmation-modal').style.display = 'flex';
            }

            function finalizeConfirmation() {
                const room = document.getElementById('confirm-room').value.trim();
                if (!room) {
                    alert('練習部屋は必須です。');
                    return;
                }
                
                const equipment = Array.from(document.querySelectorAll('#confirm-equipment input:checked'))
                                   .map(cb => cb.value);
                
                const song = dataManager.getSong(state.currentSongId);
                const newConfirmedPractices = [];
                
                // コマを日付と時限でグループ化
                const groupedSlots = state.confirmingSlots.reduce((acc, slotId) => {
                    const [date, period] = slotId.split('_');
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(period);
                    return acc;
                }, {});

                // グループごとに確定情報を作成
                for (const date in groupedSlots) {
                    const periods = groupedSlots[date];
                    const participants = getParticipantsForSlots(song, periods.map(p => `${date}_${p}`));

                    const newPractice = {
                        date: date,
                        periods: periods,
                        room: room,
                        equipment: equipment,
                        participants: participants,
                        warnings: [],
                    };
                    newConfirmedPractices.push(newPractice);
                }

                // バリデーションチェック
                const allSongsInCircle = Object.values(state.allData.songs)
                    .filter(s => s.circleCode === song.circleCode);

                newConfirmedPractices.forEach(practice => {
                    // 練習かぶりチェック
                    const overlapUsers = checkUserOverlap(practice, allSongsInCircle, song.id);
                    overlapUsers.forEach(overlap => {
                        practice.warnings.push(`⚠️ ${overlap.user}さんは「${overlap.song}」と練習がかぶっています。`);
                    });

                    // 機材在庫チェック
                    const equipmentShortages = checkEquipmentStock(practice, allSongsInCircle, song.id);
                    equipmentShortages.forEach(shortage => {
                        practice.warnings.push(`⚠️ 機材「${shortage.item}」の在庫が不足しています (他曲と重複)。`);
                    });
                });

                // 確定情報を保存
                if (!song.confirmed) song.confirmed = [];
                song.confirmed.push(...newConfirmedPractices);
                dataManager.setSong(song);

                // UIを更新
                document.getElementById('practice-confirmation-modal').style.display = 'none';
                showScheduleInputScreen(); // 画面全体を再描画
                alert('練習コマを確定しました。警告がある場合は内容を確認してください。');
            }


            // ===== ヘルパー関数 =====
            function getDatesInRange(startDate, endDate) {
                const dates = [];
                let currentDate = new Date(startDate);
                const lastDate = new Date(endDate);
                currentDate.setUTCHours(0,0,0,0); // タイムゾーンの影響を避ける
                lastDate.setUTCHours(0,0,0,0);

                while (currentDate <= lastDate) {
                    dates.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return dates;
            }

            function formatDate(date) {
                // UTC日付として扱うことでタイムゾーン問題を回避
                const year = date.getUTCFullYear();
                const month = date.getUTCMonth() + 1;
                const day = date.getUTCDate();
                const dayOfWeek = ['日','月','火','水','木','金','土'][date.getUTCDay()];
                return `${month}/${day}(${dayOfWeek})`;
            }


            function isSlotConfirmed(song, cellId) {
                if (!song.confirmed) return false;
                const [date, period] = cellId.split('_');
                return song.confirmed.some(p => p.date === date && p.periods.includes(period));
            }
            
            function getParticipantsForSlots(song, slotIds) {
                const participants = new Set();
                if (!song.availability) return [];
                slotIds.forEach(slotId => {
                    Object.entries(song.availability).forEach(([nickname, avail]) => {
                        if (avail.includes(slotId)) {
                            participants.add(nickname);
                        }
                    });
                });
                return Array.from(participants);
            }
            
            // ===== バリデーション関数 =====

            function checkUserOverlap(newPractice, allSongs, currentSongId) {
                const overlaps = [];
                newPractice.participants.forEach(participant => {
                    allSongs.forEach(song => {
                        if (!song.confirmed) return;
                        song.confirmed.forEach(existingPractice => {
                            if (song.id === currentSongId && arePracticesSame(newPractice, existingPractice)) {
                                 return;
                            }
                            const isSameDay = existingPractice.date === newPractice.date;
                            const hasTimeOverlap = existingPractice.periods.some(p => newPractice.periods.includes(p));

                            if (isSameDay && hasTimeOverlap && existingPractice.participants.includes(participant)) {
                                overlaps.push({ user: participant, song: song.songTitle });
                            }
                        });
                    });
                });
                // 重複を削除
                const uniqueOverlaps = Array.from(new Set(overlaps.map(JSON.stringify))).map(JSON.parse);
                return uniqueOverlaps;
            }
            
            function arePracticesSame(p1, p2) {
                return p1.date === p2.date && p1.room === p2.room && JSON.stringify(p1.periods.sort()) === JSON.stringify(p2.periods.sort());
            }

            function checkEquipmentStock(newPractice, allSongs, currentSongId) {
                const shortages = [];
                newPractice.equipment.forEach(item => {
                    let usedCount = 1; // 今回確定する分
                    
                    allSongs.forEach(song => {
                        if (!song.confirmed) return;
                        song.confirmed.forEach(existingPractice => {
                             if (song.id === currentSongId && arePracticesSame(newPractice, existingPractice)) {
                                return;
                            }

                            const isSameDay = existingPractice.date === newPractice.date;
                            const hasTimeOverlap = existingPractice.periods.some(p => newPractice.periods.includes(p));

                            if (isSameDay && hasTimeOverlap && existingPractice.equipment.includes(item)) {
                                usedCount++;
                            }
                        });
                    });

                    if (usedCount > EQUIPMENT_STOCK[item]) {
                        shortages.push({ item: item, count: usedCount });
                    }
                });
                return shortages;
            }


            // ===== アプリケーション開始 =====
            init();
        });
    </script>
</body>
</html>
